name: preview.yml
on:
    pull_request:
    workflow_dispatch:

permissions:
  pull-requests: write
  contents: write


jobs:
  build:
    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_EC2_METADATA_DISABLED: true
      AWS_REGION: auto
      S3_UPLOAD_BUCKET: ${{ secrets.S3_UPLOAD_BUCKET }}
      S3_ENDPOINT: ${{ secrets.S3_ENDPOINT }}
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - uses: actions/setup-java@c5195efecf7bdfc987ee8bae7a71cb8b11521c00 # v4.7.1
        with:
          distribution: 'temurin'
          java-version: '21'
          cache: 'gradle'

      - name: Change wrapper permissions
        run: chmod +x ./gradlew

      - name: Set short git commit SHA
        id: vars
        run: |
          calculatedSha=$(git rev-parse --short ${{ github.sha }})
          echo "COMMIT_SHORT_SHA=$calculatedSha" >> $GITHUB_ENV

      - name: change plugin.yml version
        run: |
          before="$GITHUB_ENV"
          after="${before//v/}"
          sed -i 's/VersionPlaceholder/$after/' ./gradle.properties

      - name: Build with Gradle
        run: ./gradlew build

      - name: Upload build artifacts
        id: upload-artifacts
        run: |
          mkdir -p ./upload
          mkdir -p ./upload/jars
          mv ./bukkit/build/libs/bukkit-*-all.jar ./upload/jars/MoripaFishing-bukkit-${{ env.COMMIT_SHORT_SHA }}.jar
          mv ./api/build/libs/api-*.jar ./upload/jars/MoripaFishing-api-${{ env.COMMIT_SHORT_SHA }}.jar
          mkdir -p ./upload/junit
          cp -r ./bukkit/build/reports/tests/test/* ./upload/junit/
          mkdir -p ./upload/detekt
          cp -r ./build/reports/detekt/* ./upload/detekt/
          aws s3 cp ./upload --endpoint-url ${S3_ENDPOINT} s3://${{ env.S3_UPLOAD_BUCKET }}/${{ env.COMMIT_SHORT_SHA }} --recursive

      - name: Publish test results
        id: publish-test-results
        uses: mikepenz/action-junit-report@cf701569b05ccdd861a76b8607a66d76f6fd4857 # v5.5.1
        if: success() || failure()
        with:
          report_paths: './**/build/test-results/test/TEST-*.xml'

      - name: Create comment file
        id: create-comment-file
        env:
          ARTIFACT_URL: "https://mf-ci.nikomaru.dev/${{ env.COMMIT_SHORT_SHA }}/jars/MoripaFishing-bukkit-${{ env.COMMIT_SHORT_SHA }}.jar"
          ARTIFACT_URL_API: "https://mf-ci.nikomaru.dev/${{ env.COMMIT_SHORT_SHA }}/jars/MoripaFishing-api-${{ env.COMMIT_SHORT_SHA }}.jar"
          JUNIT_REPORT_URL: "https://mf-ci.nikomaru.dev/${{ env.COMMIT_SHORT_SHA }}/junit/index.html"
          DETEKT_REPORT_URL: "https://mf-ci.nikomaru.dev/${{ env.COMMIT_SHORT_SHA }}/detekt/index.html"
        run: |
          cat  << EOF > comment.md
          ## üöÄ Preview jars of ${{ github.event.repository.name }}
          <table>
            <tr>
              <th scope="row">Preview Jars Bukkit</th>
              <td><a href="$ARTIFACT_URL">$ARTIFACT_URL</a></td>
              <th scope="row">Preview Jars API</th>
              <td><a href="$ARTIFACT_URL_API">$ARTIFACT_URL_API</a></td>
              <th scope="row">JUnit Report</th>
              <td><a href="$JUNIT_REPORT_URL">$JUNIT_REPORT_URL</a></td>
              <th scope="row">Detekt Report</th>
              <td><a href="$DETEKT_REPORT_URL">$DETEKT_REPORT_URL</a></td>
            </tr>
          </table>
          ## Test summary
          <table>
              <tr>
              <th>
                <th>Tests üíØ</th>
                <th>Passed ‚úÖ</th>
                <th>Skipped ‚è≠Ô∏è</th>
                <th>Failed ‚ùå</th>
              </tr>
              <tr>
                <td>JUnit Test Report</td>
                <td>${{ steps.publish-test-results.outputs.total }} ran</td>
                <td>${{ steps.publish-test-results.outputs.passed }} passed</td>
                <td>${{ steps.publish-test-results.outputs.skipped }} skipped</td>
                <td>${{ steps.publish-test-results.outputs.failed }} failed</td>
              </tr>
            </table>
          EOF
      - name: Create PR comment
        if: ${{ job.status == 'success' && (github.event.action == 'opened' || github.event.action == 'synchronize') }}
        run: gh pr comment ${{ github.event.number }} --body-file comment.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
