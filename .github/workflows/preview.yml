name: preview.yml
on:
  pull_request:
    types: [opened, synchronize, closed]
  workflow_dispatch:

permissions:
  pull-requests: write
  contents: write
  id-token: write
  attestations: write

env:
  AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
  AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
  AWS_EC2_METADATA_DISABLED: true
  AWS_REGION: auto
  AWS_CLI_FILE_ENCODING: UTF-8
  AWS_DEFAULT_S3_SIGNATURE_VERSION: s3v4
  S3_UPLOAD_BUCKET: ${{ secrets.S3_UPLOAD_BUCKET }}
  S3_ENDPOINT: ${{ secrets.S3_ENDPOINT }}
  PREVIEW_BASE_URL: https://moripa-ci.nikomaru.dev/moripafishing
  PROJECT_NAME: MoripaFishing

jobs:
  # ÂÖ±ÈÄö„ÅÆÂâçÂá¶ÁêÜÔºö„Ç≥„Éü„ÉÉ„ÉàSHA„ÇíÂèñÂæó
  setup:
    if: ${{ github.event.action != 'closed' }}
    runs-on: ubuntu-latest
    outputs:
      commit_sha: ${{ steps.vars.outputs.commit_sha }}
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Set short git commit SHA
        id: vars
        run: |
          calculatedSha=$(git rev-parse --short HEAD)
          echo "commit_sha=$calculatedSha" >> $GITHUB_OUTPUT

  # Gradle „Éì„É´„Éâ„Ç∏„Éß„ÉñÔºàdocs „Å®‰∏¶ÂàóÂÆüË°åÔºâ
  build-gradle:
    needs: setup
    runs-on: ubuntu-latest
    outputs:
      test_total: ${{ steps.publish-test-results.outputs.total }}
      test_passed: ${{ steps.publish-test-results.outputs.passed }}
      test_skipped: ${{ steps.publish-test-results.outputs.skipped }}
      test_failed: ${{ steps.publish-test-results.outputs.failed }}
    env:
      COMMIT_SHORT_SHA: ${{ needs.setup.outputs.commit_sha }}
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - uses: actions/setup-java@c5195efecf7bdfc987ee8bae7a71cb8b11521c00 # v4.7.1
        with:
          distribution: 'temurin'
          java-version: '21'

      # Gradle „Ç≠„É£„ÉÉ„Ç∑„É•„ÅÆË®≠ÂÆöÔºàsetup-gradle „Çí‰ΩøÁî®Ôºâ
      - uses: gradle/actions/setup-gradle@8379f6a1328ee0e06e2bb424dadb7b159856a326 # v4.4.0
        with:
          cache-read-only: ${{ github.ref != 'refs/heads/main' }}

      - name: Change wrapper permissions
        run: chmod +x ./gradlew

      - name: change plugin.yml version
        run: |
          sed -i "s/VersionPlaceholder/${{ env.COMMIT_SHORT_SHA }}/" ./gradle.properties

      - name: Build with Gradle
        continue-on-error: true
        run: ./gradlew build

      - name: Publish test results
        id: publish-test-results
        uses: mikepenz/action-junit-report@e08919a3b1fb83a78393dfb775a9c37f17d8eea6 # v6.0.1
        if: success() || failure()
        with:
          report_paths: './**/build/test-results/test/TEST-*.xml'

      - name: Prepare Gradle artifacts
        run: |
          mkdir -p ./gradle-artifacts/jars
          mkdir -p ./gradle-artifacts/junit
          mkdir -p ./gradle-artifacts/detekt
          mv ./bukkit/build/libs/bukkit-*-all.jar ./gradle-artifacts/jars/${{ env.PROJECT_NAME }}-bukkit-${{ env.COMMIT_SHORT_SHA }}.jar
          mv ./api/build/libs/api-*.jar ./gradle-artifacts/jars/${{ env.PROJECT_NAME }}-api-${{ env.COMMIT_SHORT_SHA }}.jar
          cp -r ./bukkit/build/reports/tests/test/* ./gradle-artifacts/junit/ || echo "No JUnit reports found"
          cp -r ./build/reports/detekt/* ./gradle-artifacts/detekt/ || echo "No Detekt reports found"

      # GitHub Attestations „ÅßÁΩ≤Âêç
      - name: Attest JAR artifacts
        uses: actions/attest-build-provenance@v2
        with:
          subject-path: './gradle-artifacts/jars/*.jar'

      - name: Upload Gradle artifacts
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: gradle-artifacts
          path: ./gradle-artifacts
          retention-days: 1

  # JitPack SNAPSHOT „Éì„É´„Éâ„Çí„Éà„É™„Ç¨„Éº
  trigger-jitpack:
    needs: [setup, build-gradle]
    runs-on: ubuntu-latest
    steps:
      - name: Trigger JitPack SNAPSHOT build
        run: |
          BRANCH="${{ github.head_ref }}"
          echo "Triggering JitPack SNAPSHOT build for branch: $BRANCH"
          curl -s "https://jitpack.io/api/builds/com.github.morinoparty/MoripaFishing/${BRANCH}-SNAPSHOT" || true
          echo "JitPack SNAPSHOT build triggered"

  # Docs „Éì„É´„Éâ„Ç∏„Éß„ÉñÔºàgradle „Å®‰∏¶ÂàóÂÆüË°åÔºâ
  build-docs:
    needs: setup
    runs-on: ubuntu-latest
    env:
      COMMIT_SHORT_SHA: ${{ needs.setup.outputs.commit_sha }}
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - uses: actions/setup-java@c5195efecf7bdfc987ee8bae7a71cb8b11521c00 # v4.7.1
        with:
          distribution: 'temurin'
          java-version: '21'

      # Gradle „Ç≠„É£„ÉÉ„Ç∑„É•„ÅÆË®≠ÂÆöÔºàDokka ÁîüÊàêÁî®Ôºâ
      - uses: gradle/actions/setup-gradle@8379f6a1328ee0e06e2bb424dadb7b159856a326 # v4.4.0
        with:
          cache-read-only: ${{ github.ref != 'refs/heads/main' }}

      - uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.4.0
        with:
          node-version: '22'

      - uses: pnpm/action-setup@a7487c7e89a18df4991f7f222e4898a00d66ddda # v4.1.0
        name: Install pnpm
        with:
          version: 10
          run_install: false

      # pnpm „Ç≠„É£„ÉÉ„Ç∑„É•„ÅÆË®≠ÂÆö
      - name: Get pnpm store directory
        id: pnpm-cache
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_OUTPUT

      - uses: actions/cache@5a3ec84eff668545956fd18022155c47e93e2684 # v4.2.3
        name: Setup pnpm cache
        with:
          path: ${{ steps.pnpm-cache.outputs.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Change wrapper permissions
        run: chmod +x ./gradlew

      - name: Install docs dependencies
        working-directory: docs
        run: pnpm install

      - name: Generate Dokka API documentation
        run: ./gradlew dokkaGenerate

      - name: Build Fumadocs
        working-directory: docs
        env:
          BASE_PATH: /moripafishing/${{ env.COMMIT_SHORT_SHA }}/docs
        run: pnpm run build

      - name: Upload docs artifacts
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: docs-artifacts
          path: ./docs/out
          retention-days: 1

  # GitHub Release „Å´„Éó„É¨„Éì„É•„ÉºÁâà„Å®„Åó„Å¶„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ
  upload-release:
    needs: [setup, build-gradle]
    runs-on: ubuntu-latest
    env:
      COMMIT_SHORT_SHA: ${{ needs.setup.outputs.commit_sha }}
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    outputs:
      release_url: ${{ steps.create-release.outputs.release_url }}
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Download JAR artifacts
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
        with:
          name: gradle-artifacts
          path: ./artifacts

      # „Éó„É¨„Éì„É•„Éº„É™„É™„Éº„Çπ„Çí‰ΩúÊàê
      - name: Create preview release
        id: create-release
        run: |
          TAG_NAME="preview-pr${{ github.event.pull_request.number }}-${{ env.COMMIT_SHORT_SHA }}"
          RELEASE_URL=$(gh release create "$TAG_NAME" \
            --title "üß™ Preview: PR #${{ github.event.pull_request.number }} (${{ env.COMMIT_SHORT_SHA }})" \
            --notes "Preview build for PR #${{ github.event.pull_request.number }}

          **Commit:** ${{ github.sha }}
          **Branch:** ${{ github.head_ref }}

          > ‚ö†Ô∏è This is a preview build and may be unstable.
          > üìú Verify with: \`gh attestation verify <jar-file> --owner morinoparty\`" \
            --prerelease \
            ./artifacts/jars/*.jar)
          echo "release_url=https://github.com/${{ github.repository }}/releases/tag/$TAG_NAME" >> $GITHUB_OUTPUT

  # S3 „Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Ç∏„Éß„ÉñÔºàDocs „Å®„É¨„Éù„Éº„Éà„ÅÆ„ÅøÔºâ
  upload-s3:
    needs: [setup, build-gradle, build-docs]
    runs-on: ubuntu-latest
    env:
      COMMIT_SHORT_SHA: ${{ needs.setup.outputs.commit_sha }}
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
        with:
          path: ./artifacts

      - name: Prepare upload directory
        run: |
          mkdir -p ./upload
          cp -r ./artifacts/gradle-artifacts/junit ./upload/ || echo "No JUnit reports"
          cp -r ./artifacts/gradle-artifacts/detekt ./upload/ || echo "No Detekt reports"
          mkdir -p ./upload/docs
          mv ./artifacts/docs-artifacts/* ./upload/docs/

      - name: Upload to S3 (parallel)
        run: |
          # AWS CLI„ÅÆ‰∏¶Âàó„É™„ÇØ„Ç®„Çπ„ÉàÊï∞„ÇíÂ¢ó„ÇÑ„Åô
          aws configure set default.s3.max_concurrent_requests 50

          S3_BASE="s3://${{ env.S3_UPLOAD_BUCKET }}/moripafishing/${{ env.COMMIT_SHORT_SHA }}"
          S3_OPTS="--endpoint-url ${S3_ENDPOINT} --only-show-errors"

          # Docs „Å® „É¨„Éù„Éº„Éà„Çí‰∏¶Âàó„Åß„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ
          aws s3 cp ./upload/junit $S3_BASE/junit $S3_OPTS --recursive &
          aws s3 cp ./upload/detekt $S3_BASE/detekt $S3_OPTS --recursive &
          aws s3 cp ./upload/docs $S3_BASE/docs $S3_OPTS --recursive &

          # ÂÖ®„Å¶„ÅÆ‰∏¶Âàó„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„ÇíÂæÖÊ©ü
          wait
          echo "S3 upload completed"

  # „Ç≥„É°„É≥„Éà‰ΩúÊàê„Ç∏„Éß„Éñ
  comment:
    needs: [setup, build-gradle, upload-s3, upload-release]
    runs-on: ubuntu-latest
    if: ${{ github.event.action == 'opened' || github.event.action == 'synchronize' }}
    env:
      COMMIT_SHORT_SHA: ${{ needs.setup.outputs.commit_sha }}
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Get limit time
        id: limit-time
        run: |
          limit_time=$(date -d "7 days" +%Y-%m-%d)
          echo "LIMIT_TIME=$limit_time" >> $GITHUB_ENV

      - name: Create comment file
        env:
          RELEASE_URL: "${{ needs.upload-release.outputs.release_url }}"
          RELEASE_DOWNLOAD_BASE: "https://github.com/${{ github.repository }}/releases/download/preview-pr${{ github.event.pull_request.number }}-${{ env.COMMIT_SHORT_SHA }}"
          JUNIT_REPORT_URL: "${{ env.PREVIEW_BASE_URL }}/${{ env.COMMIT_SHORT_SHA }}/junit/index.html"
          DETEKT_REPORT_URL: "${{ env.PREVIEW_BASE_URL }}/${{ env.COMMIT_SHORT_SHA }}/detekt/detekt.html"
          DOCS_PREVIEW_URL: "${{ env.PREVIEW_BASE_URL }}/${{ env.COMMIT_SHORT_SHA }}/docs/index.html"
          DOKKA_URL: "${{ env.PREVIEW_BASE_URL }}/${{ env.COMMIT_SHORT_SHA }}/docs/dokka/index.html"
          LIMIT_TIME: ${{ env.LIMIT_TIME }}
        run: |
          cat << EOF > comment.md
          ## üöÄ Preview of ${{ github.event.repository.name }}

          ### üì¶ Preview JARs ([Release Page]($RELEASE_URL))
          | Artifact | Download |
          |----------|----------|
          | Bukkit | [${{ env.PROJECT_NAME }}-bukkit-${{ env.COMMIT_SHORT_SHA }}.jar]($RELEASE_DOWNLOAD_BASE/${{ env.PROJECT_NAME }}-bukkit-${{ env.COMMIT_SHORT_SHA }}.jar) |
          | API | [${{ env.PROJECT_NAME }}-api-${{ env.COMMIT_SHORT_SHA }}.jar]($RELEASE_DOWNLOAD_BASE/${{ env.PROJECT_NAME }}-api-${{ env.COMMIT_SHORT_SHA }}.jar) |

          > üìú **Attestation**: \`gh attestation verify <jar-file> --owner morinoparty\`

          ### üìñ Documentation & Reports
          Available for 7 days (until $LIMIT_TIME)
          | Resource | Link |
          |----------|------|
          | üìñ Documentation | [Preview]($DOCS_PREVIEW_URL) |
          | üìñ Dokka API | [Preview]($DOKKA_URL) |
          | üß™ JUnit Report | [Report]($JUNIT_REPORT_URL) |
          | üîç Detekt Report | [Report]($DETEKT_REPORT_URL) |

          ### üß™ Test Summary
          | Tests | Passed | Skipped | Failed |
          |-------|--------|---------|--------|
          | ${{ needs.build-gradle.outputs.test_total }} | ${{ needs.build-gradle.outputs.test_passed }} ‚úÖ | ${{ needs.build-gradle.outputs.test_skipped }} ‚è≠Ô∏è | ${{ needs.build-gradle.outputs.test_failed }} ‚ùå |
          EOF

      - name: Create PR comment
        run: gh pr comment ${{ github.event.number }} --body-file comment.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
